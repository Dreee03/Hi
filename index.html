<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Digicam Rental Organizer</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#0f1730;
      --stroke:#24335e;
      --text:#eaf0ff;
      --muted:#a9b7e6;
      --accent:#7aa2ff;
      --good:#4ade80;
      --warn:#fbbf24;
      --bad:#fb7185;
      --track:#0a1330;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 10% 10%, #1a2a55 0%, transparent 60%),
        radial-gradient(900px 600px at 90% 20%, #2a1f5a 0%, transparent 55%),
        linear-gradient(180deg, #0f1b33, var(--bg));
      min-height:100vh;
    }

    /* Layout container */
    .container{
      max-width:1100px;
      margin:0 auto;
      padding:18px 16px 24px;
    }

    /* Top bar / nav */
    .topbar{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      margin-bottom:14px;
    }
    .brand{
      display:flex; gap:10px; align-items:center;
    }
    .brand h1{
      margin:0;
      font-size:clamp(20px, 2.2vw, 30px);
      letter-spacing:.2px;
    }
    .brand p{
      margin:4px 0 0;
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
      max-width:72ch;
    }
    .nav{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .tab{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:9px 12px;
      border-radius:999px;
      border:1px solid #2a3a6b;
      background:#0f1730;
      color:#dbe6ff;
      text-decoration:none;
      font-weight:800;
      font-size:13px;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      border-color: transparent;
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      color:#071029;
    }
    .actions{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      background:#0f1730; border:1px solid #2a3a6b;
      color:var(--muted); font-size:12px;
      white-space:nowrap;
    }

    /* Cards */
    .card{
      background: rgba(18,28,51,.78);
      border:1px solid var(--stroke);
      border-radius:16px;
      padding:14px;
      backdrop-filter: blur(10px);
      box-shadow: 0 12px 30px rgba(0,0,0,.22);
    }
    .card h2{
      margin:0 0 10px;
      font-size:15px;
      color:#dbe6ff;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .muted{color:var(--muted)}
    .hide{display:none !important}

    /* Form */
    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px;}
    input, select, textarea{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid #2a3a6b;
      background:#0f1730;
      color:var(--text);
      outline:none;
    }
    input:focus, select:focus, textarea:focus{
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(122,162,255,.18);
    }
    textarea{min-height:64px; resize:vertical}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    .row3{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px;}
    .btns{display:flex; gap:10px; margin-top:12px; flex-wrap:wrap;}
    button{
      border:1px solid #2a3a6b;
      background:#12204a;
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:900;
    }
    button:hover{filter:brightness(1.08)}
    .primary{
      background: linear-gradient(135deg, #3b82f6, #8b5cf6);
      border-color: transparent;
    }
    .ghost{
      background:transparent;
      border-color:#2a3a6b;
      color:#dbe6ff;
    }
    .danger{
      background:#2a1220;
      border-color:#4a2034;
      color:#ffd5de;
    }

    /* Pages */
    .page{display:none}
    .page.active{display:block}

    /* Dashboard layout (desktop) */
    .grid{
      display:grid;
      grid-template-columns: 380px 1fr;
      gap:14px;
      align-items:start;
    }

    /* Bookings controls */
    .controls{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      margin-bottom:10px;
    }
    .controls .left{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .controls input, .controls select{
      width:auto;
      min-width: 180px;
      padding:9px 10px;
      border-radius:999px;
    }
    .stats{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}

    /* Table (desktop/tablet landscape) */
    .tableWrap{
      overflow:auto;
      max-height: 72vh;
      border-radius:14px;
    }
    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      border-radius:14px;
      border:1px solid var(--stroke);
      background:#0f1730;
      overflow:hidden;
      min-width: 900px; /* lets smaller screens scroll horizontally */
    }
    thead th{
      text-align:left;
      font-size:12px;
      color:#cfe0ff;
      padding:10px 10px;
      border-bottom:1px solid #22315b;
      background: #0c1430;
      position:sticky; top:0; z-index:1;
      white-space:nowrap;
    }
    tbody td{
      padding:10px 10px;
      border-bottom:1px solid #18244a;
      font-size:13px;
      vertical-align:top;
    }
    tbody tr:hover{background:#0e1b3a}
    .nowrap{white-space:nowrap}
    .tag{
      display:inline-flex; align-items:center;
      padding:4px 8px; border-radius:999px; font-size:12px;
      border:1px solid #2a3a6b;
      color:#d7e5ff; background:#0a1230;
      white-space:nowrap;
    }
    .tag.good{border-color: rgba(74,222,128,.35); color:#d5ffe2}
    .tag.warn{border-color: rgba(251,191,36,.35); color:#fff1c7}
    .tag.bad{border-color: rgba(251,113,133,.35); color:#ffd2db}

    /* Monitor bar */
    .barWrap{display:flex; flex-direction:column; gap:6px; min-width:240px;}
    .barTop{
      display:flex; gap:8px; align-items:center; justify-content:space-between;
      font-size:12px; color:var(--muted);
    }
    .barTrack{
      position:relative; height:10px; width:100%;
      border-radius:999px; background: var(--track);
      border:1px solid #22315b; overflow:hidden;
    }
    .barFill{
      position:absolute; inset:0 auto 0 0; width:0%;
      border-radius:999px;
      background: linear-gradient(90deg, #3b82f6, #8b5cf6);
    }
    .barMarkers{display:flex; justify-content:space-between; font-size:11px; color:var(--muted);}
    .barNote{font-size:11px; color:var(--muted);}

    .miniBtns{display:flex; gap:8px; flex-wrap:wrap;}
    .miniBtns button{padding:7px 10px; border-radius:10px; font-size:12px; font-weight:900;}

    /* Mobile card list (Bookings page) */
    .cardsList{
      display:none;
      gap:10px;
      flex-direction:column;
    }
    .bookingCard{
      background:#0f1730;
      border:1px solid var(--stroke);
      border-radius:14px;
      padding:12px;
    }
    .bookingCardTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .bookingCardTop .title{
      font-weight:900;
      letter-spacing:.2px;
    }
    .bookingCardTop .sub{
      color:var(--muted);
      font-size:12px;
      margin-top:2px;
      line-height:1.3;
    }
    .kv{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:8px 10px;
      margin:10px 0 8px;
      color:var(--muted);
      font-size:12px;
    }
    .kv b{color:var(--text); font-weight:800}
    .inlineRow{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      margin-top:10px;
    }

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background:#0f1730;
      border:1px solid #2a3a6b;
      color:#dbe6ff;
      padding:10px 12px;
      border-radius:999px;
      font-size:13px;
      opacity:0;
      pointer-events:none;
      transition:opacity .18s ease, transform .18s ease;
      box-shadow: 0 10px 26px rgba(0,0,0,.25);
    }
    .toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(-6px);
    }

    .footer{
      margin-top:14px;
      color:var(--muted);
      font-size:12px;
    }

    /* =========================
       RESPONSIVE: Mobile / iPad
       ========================= */

    /* iPad portrait and below */
    @media (max-width: 900px){
      .grid{grid-template-columns: 1fr;}
      .controls input, .controls select{min-width: 160px;}
    }

    /* Mobile */
    @media (max-width: 600px){
      .brand{width:100%}
      .brand p{max-width:100%}
      .actions{width:100%; justify-content:flex-start}
      .controls .left{width:100%}
      .controls input, .controls select{
        min-width: 0;
        width:100%;
      }
      .row, .row3{grid-template-columns: 1fr;}
      .tableWrap{display:none;}
      .cardsList{display:flex;}
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- TOP BAR -->
    <div class="topbar">
      <div class="brand">
        <div>
          <h1>ðŸ“¸ Digicam Rental Organizer</h1>
          <p>
            Simple real-world setup: <b>Dashboard</b> to add/edit bookings, <b>Bookings</b> to monitor rentals.
            Autosaves on this device.
          </p>
        </div>
      </div>

      <div class="nav" role="navigation" aria-label="Pages">
        <a class="tab" id="tabDashboard" href="#/dashboard">Dashboard</a>
        <a class="tab" id="tabBookings" href="#/bookings">Bookings</a>
      </div>

      <div class="actions">
        <span class="pill">Autosave: On</span>
        <button class="ghost" id="exportBtn" type="button">Export CSV</button>
        <button class="ghost" id="importBtn" type="button">Import CSV</button>
        <input id="importFile" type="file" accept=".csv" style="display:none"/>
      </div>
    </div>

    <!-- PAGES -->
    <section class="page" id="pageDashboard" aria-label="Dashboard page">
      <div class="grid">
        <!-- FORM -->
        <div class="card">
          <h2>
            <span id="formTitle">New Booking</span>
            <span class="muted" style="font-size:12px" id="endsAtInline">Ends: â€”</span>
          </h2>

          <div class="row">
            <div>
              <label for="client">Client Name *</label>
              <input id="client" placeholder="e.g., Maria Cruz" autocomplete="name" />
            </div>
            <div>
              <label for="contact">Contact (optional)</label>
              <input id="contact" placeholder="e.g., 09XXXXXXXXX" autocomplete="tel" />
            </div>
          </div>

          <label for="unit">Camera Unit *</label>
          <input id="unit" placeholder="e.g., Canon G7X / Sony ZV-1" />

          <div class="row3">
            <div>
              <label for="startDate">Start Date *</label>
              <input id="startDate" type="date" />
            </div>
            <div>
              <label for="startTime">Start Time *</label>
              <input id="startTime" type="time" />
            </div>
            <div>
              <label for="hours">Hours *</label>
              <input id="hours" type="number" min="0.5" step="0.5" placeholder="e.g., 6" />
            </div>
          </div>

          <div class="row">
            <div>
              <label for="status">Status</label>
              <select id="status">
                <option value="Reserved">Reserved</option>
                <option value="Ongoing">Ongoing</option>
                <option value="Returned">Returned</option>
                <option value="Cancelled">Cancelled</option>
              </select>
            </div>
            <div>
              <label for="payment">Payment</label>
              <select id="payment">
                <option value="Unpaid">Unpaid</option>
                <option value="Downpayment">Downpayment</option>
                <option value="Paid">Paid</option>
                <option value="Refunded">Refunded</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label for="price">Price (optional)</label>
              <input id="price" type="number" min="0" step="1" placeholder="e.g., 800" />
            </div>
            <div>
              <label for="bookingId">Booking ID</label>
              <input id="bookingId" placeholder="Auto-generated" />
            </div>
          </div>

          <label for="notes">Notes (optional)</label>
          <textarea id="notes" placeholder="e.g., Includes extra battery, meetup at SM."></textarea>

          <div class="btns">
            <button class="primary" id="saveBtn" type="button">Save</button>
            <button class="ghost" id="resetBtn" type="button">New</button>
            <button class="danger" id="clearAllBtn" type="button" title="Deletes all bookings">Clear All</button>
          </div>

          <div class="footer">
            Tip: You can add bookings here, then go to <b>Bookings</b> to monitor them.
          </div>
        </div>

        <!-- QUICK PREVIEW (simple) -->
        <div class="card">
          <h2>
            <span>Quick Overview</span>
            <span class="muted" style="font-size:12px" id="nowClock">â€”</span>
          </h2>

          <div id="overviewStats" style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;"></div>

          <div class="footer" style="margin-top:10px;">
            This is a lightweight app (single HTML file). Works on mobile, iPad, and desktop.
          </div>
        </div>
      </div>
    </section>

    <section class="page" id="pageBookings" aria-label="Bookings page">
      <div class="card">
        <h2>
          <span>Bookings</span>
          <span class="muted" style="font-size:12px">Monitor bars are here âœ…</span>
        </h2>

        <div class="controls">
          <div class="left">
            <input id="search" placeholder="Search name / unit / ID..." />
            <select id="filterStatus">
              <option value="All">All Status</option>
              <option value="Reserved">Reserved</option>
              <option value="Ongoing">Ongoing</option>
              <option value="Returned">Returned</option>
              <option value="Cancelled">Cancelled</option>
            </select>
            <select id="sortBy">
              <option value="endAsc">Sort: End â†‘</option>
              <option value="endDesc">Sort: End â†“</option>
              <option value="startAsc">Sort: Start â†‘</option>
              <option value="startDesc">Sort: Start â†“</option>
            </select>
          </div>
          <div class="stats" id="stats"></div>
        </div>

        <!-- Desktop/tablet table -->
        <div class="tableWrap">
          <table>
            <thead>
              <tr>
                <th>Booking</th>
                <th>Client</th>
                <th>Unit</th>
                <th>Start</th>
                <th>End</th>
                <th>Monitor</th>
                <th>Status</th>
                <th>Payment</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>

        <!-- Mobile card list -->
        <div class="cardsList" id="cardsList"></div>

        <div class="footer">
          Data is saved in your browser storage. Export CSV for backup/moving devices.
        </div>
      </div>
    </section>
  </div>

  <div class="toast" id="toast">Saved âœ…</div>

  <script>
    // =========================
    // Simple SPA pages: #/dashboard, #/bookings
    // Responsive: desktop/iPad/mobile
    // Monitor bars live on Bookings page
    // =========================

    const $ = (id) => document.getElementById(id);
    const KEY = "digicam_rental_app_pages_v1";
    const DRAFT_KEY = KEY + "_draft";

    const state = {
      bookings: [],
      editingId: null
    };

    // ---- helpers
    const pad2 = (n) => String(n).padStart(2,"0");
    const clamp = (n,min,max) => Math.max(min, Math.min(max,n));

    function formatDT(dateISO){
      const d = new Date(dateISO);
      if(isNaN(d)) return "â€”";
      const datePart = d.toLocaleDateString(undefined, { year:"numeric", month:"short", day:"2-digit" });
      let h = d.getHours();
      const m = pad2(d.getMinutes());
      const ampm = h >= 12 ? "PM" : "AM";
      h = h % 12; if(h===0) h = 12;
      return `${datePart} ${h}:${m} ${ampm}`;
    }
    function formatTimeOnly(date){
      const d = new Date(date);
      if(isNaN(d)) return "â€”";
      let h = d.getHours();
      const m = pad2(d.getMinutes());
      const ampm = h >= 12 ? "PM" : "AM";
      h = h % 12; if(h===0) h = 12;
      return `${h}:${m} ${ampm}`;
    }
    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function makeId(){
      return "B" + Math.random().toString(16).slice(2,6).toUpperCase() + "-" + Date.now().toString().slice(-4);
    }

    function computeStartEnd(startDate, startTime, hours){
      if(!startDate || !startTime || hours === "" || hours === null) return null;
      const h = Number(hours);
      if(!isFinite(h) || h <= 0) return null;
      const [hh, mm] = startTime.split(":").map(Number);
      const start = new Date(startDate);
      if(isNaN(start)) return null;
      start.setHours(hh || 0, mm || 0, 0, 0);
      const end = new Date(start.getTime() + h * 3600 * 1000);
      return { startISO: start.toISOString(), endISO: end.toISOString() };
    }

    function statusTagClass(status){
      if(status === "Returned") return "good";
      if(status === "Ongoing") return "warn";
      if(status === "Cancelled") return "bad";
      return "";
    }

    function monitorInfo(startISO, endISO){
      const start = new Date(startISO);
      const end = new Date(endISO);
      const now = new Date();
      if(isNaN(start) || isNaN(end) || end <= start){
        return { pct: 0, range: "â€”", nowLabel: "Now: â€”", note: "" };
      }
      const total = end - start;
      const elapsed = now - start;
      const pct = clamp((elapsed/total)*100, 0, 100);

      let note = "";
      if(now < start) note = "Not started yet";
      else if(now >= end) note = "Ended";
      else {
        const minsLeft = Math.ceil((end - now) / (1000*60));
        note = `${minsLeft} min left`;
      }
      return {
        pct,
        range: `${formatTimeOnly(start)} â†’ ${formatTimeOnly(end)}`,
        nowLabel: `Now: ${formatTimeOnly(now)}`,
        note
      };
    }

    function showToast(msg){
      const t = $("toast");
      t.textContent = msg;
      t.classList.add("show");
      clearTimeout(showToast._timer);
      showToast._timer = setTimeout(() => t.classList.remove("show"), 1200);
    }

    // ---- persistence
    function load(){
      try{
        const raw = localStorage.getItem(KEY);
        state.bookings = raw ? JSON.parse(raw) : [];
      }catch{
        state.bookings = [];
      }
    }
    function persist(){
      localStorage.setItem(KEY, JSON.stringify(state.bookings));
      showToast("Saved âœ…");
    }

    // ---- form elements
    const client = $("client");
    const contact = $("contact");
    const unit = $("unit");
    const startDate = $("startDate");
    const startTime = $("startTime");
    const hours = $("hours");
    const status = $("status");
    const payment = $("payment");
    const price = $("price");
    const bookingId = $("bookingId");
    const notes = $("notes");

    function setNowDefaults(){
      const now = new Date();
      startDate.value = now.toISOString().slice(0,10);
      startTime.value = pad2(now.getHours()) + ":" + pad2(now.getMinutes());
    }
    function updateEndsInline(){
      const res = computeStartEnd(startDate.value, startTime.value, hours.value);
      $("endsAtInline").textContent = "Ends: " + (res ? formatDT(res.endISO) : "â€”");
    }

    function resetForm(){
      state.editingId = null;
      $("formTitle").textContent = "New Booking";
      $("saveBtn").textContent = "Save";

      client.value = "";
      contact.value = "";
      unit.value = "";
      hours.value = "";
      status.value = "Reserved";
      payment.value = "Unpaid";
      price.value = "";
      bookingId.value = "";
      notes.value = "";
      setNowDefaults();
      updateEndsInline();
      client.focus();
      saveDraft();
    }

    function validate(){
      if(!client.value.trim()) return "Client name is required.";
      if(!unit.value.trim()) return "Camera unit is required.";
      const res = computeStartEnd(startDate.value, startTime.value, hours.value);
      if(!res) return "Start date, start time, and hours are required.";
      return null;
    }

    function upsertBooking(){
      const err = validate();
      if(err){ alert(err); return; }

      const res = computeStartEnd(startDate.value, startTime.value, hours.value);

      const item = {
        id: state.editingId || (crypto.randomUUID?.() || (Date.now()+"_"+Math.random())),
        bookingId: bookingId.value.trim() || makeId(),
        client: client.value.trim(),
        contact: contact.value.trim(),
        unit: unit.value.trim(),
        startISO: res.startISO,
        endISO: res.endISO,
        hours: Number(hours.value),
        status: status.value,
        payment: payment.value,
        price: price.value ? Number(price.value) : null,
        notes: notes.value.trim(),
        updatedAtISO: new Date().toISOString()
      };

      if(state.editingId){
        state.bookings = state.bookings.map(b => b.id === state.editingId ? item : b);
      } else {
        state.bookings.push(item);
      }

      persist();
      renderAll();
      resetForm();
      // take user to bookings to monitor (less hassle)
      location.hash = "#/bookings";
    }

    // ---- draft autosave (prevents losing form on refresh)
    function saveDraft(){
      const draft = {
        client: client.value,
        contact: contact.value,
        unit: unit.value,
        startDate: startDate.value,
        startTime: startTime.value,
        hours: hours.value,
        status: status.value,
        payment: payment.value,
        price: price.value,
        bookingId: bookingId.value,
        notes: notes.value
      };
      localStorage.setItem(DRAFT_KEY, JSON.stringify(draft));
    }
    function loadDraft(){
      try{
        const raw = localStorage.getItem(DRAFT_KEY);
        if(!raw) return;
        const d = JSON.parse(raw);
        // only load if user isn't editing an existing one
        if(!state.editingId){
          client.value = d.client || "";
          contact.value = d.contact || "";
          unit.value = d.unit || "";
          startDate.value = d.startDate || startDate.value;
          startTime.value = d.startTime || startTime.value;
          hours.value = d.hours || "";
          status.value = d.status || "Reserved";
          payment.value = d.payment || "Unpaid";
          price.value = d.price || "";
          bookingId.value = d.bookingId || "";
          notes.value = d.notes || "";
          updateEndsInline();
        }
      }catch{}
    }

    // ---- list view filters
    function setStats(){
      const total = state.bookings.length;
      const ongoing = state.bookings.filter(b => b.status === "Ongoing").length;
      const reserved = state.bookings.filter(b => b.status === "Reserved").length;
      const returned = state.bookings.filter(b => b.status === "Returned").length;

      $("stats").innerHTML = `
        <span class="pill">Total: <b style="color:var(--text)">${total}</b></span>
        <span class="pill">Reserved: <b style="color:var(--text)">${reserved}</b></span>
        <span class="pill">Ongoing: <b style="color:var(--text)">${ongoing}</b></span>
        <span class="pill">Returned: <b style="color:var(--text)">${returned}</b></span>
      `;
      $("overviewStats").innerHTML = $("stats").innerHTML;
    }

    function getView(){
      const q = $("search").value.trim().toLowerCase();
      const f = $("filterStatus").value;
      const sortBy = $("sortBy").value;

      let list = [...state.bookings];

      if(f !== "All") list = list.filter(b => b.status === f);

      if(q){
        list = list.filter(b =>
          (b.client||"").toLowerCase().includes(q) ||
          (b.unit||"").toLowerCase().includes(q) ||
          (b.bookingId||"").toLowerCase().includes(q) ||
          (b.contact||"").toLowerCase().includes(q)
        );
      }

      const sorters = {
        endAsc:    (a,b) => (a.endISO||"").localeCompare(b.endISO||""),
        endDesc:   (a,b) => (b.endISO||"").localeCompare(a.endISO||""),
        startAsc:  (a,b) => (a.startISO||"").localeCompare(b.startISO||""),
        startDesc: (a,b) => (b.startISO||"").localeCompare(a.startISO||""),
      };
      list.sort(sorters[sortBy] || sorters.endAsc);
      return list;
    }

    function renderBookings(){
      setStats();
      const list = getView();

      // Desktop/tablet table
      const tbody = $("tbody");
      tbody.innerHTML = "";

      // Mobile cards
      const cards = $("cardsList");
      cards.innerHTML = "";

      if(list.length === 0){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="9" style="color:var(--muted); padding:16px;">No bookings yet.</td>`;
        tbody.appendChild(tr);

        const empty = document.createElement("div");
        empty.className = "bookingCard";
        empty.innerHTML = `<div class="muted">No bookings yet. Add one in Dashboard.</div>`;
        cards.appendChild(empty);
        return;
      }

      for(const b of list){
        const p = monitorInfo(b.startISO, b.endISO);

        // table row
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="nowrap"><b>${escapeHtml(b.bookingId)}</b></td>
          <td>
            <div><b>${escapeHtml(b.client)}</b></div>
            <div style="color:var(--muted); font-size:12px;">${escapeHtml(b.contact || "")}</div>
          </td>
          <td>${escapeHtml(b.unit)}</td>
          <td class="nowrap">${formatDT(b.startISO)}</td>
          <td class="nowrap">${formatDT(b.endISO)}</td>
          <td>
            <div class="barWrap">
              <div class="barTop">
                <span class="nowrap">${escapeHtml(p.range)}</span>
                <span class="nowrap">${Math.round(p.pct)}%</span>
              </div>
              <div class="barTrack" title="${escapeHtml(p.nowLabel)}">
                <div class="barFill" style="width:${p.pct}%;"></div>
              </div>
              <div class="barMarkers"><span>Start</span><span>Now</span><span>End</span></div>
              <div class="barNote">${escapeHtml(p.nowLabel)} â€¢ ${escapeHtml(p.note)}</div>
            </div>
          </td>
          <td><span class="tag ${statusTagClass(b.status)}">${escapeHtml(b.status)}</span></td>
          <td>
            <div>${escapeHtml(b.payment || "â€”")}</div>
            <div style="color:var(--muted); font-size:12px;">${b.price ? ("â‚±" + Number(b.price).toLocaleString()) : ""}</div>
          </td>
          <td class="nowrap">
            <div class="miniBtns">
              <button type="button" onclick="editBooking('${b.id}')">Edit</button>
              <button type="button" class="danger" onclick="deleteBooking('${b.id}')">Delete</button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);

        // mobile card
        const c = document.createElement("div");
        c.className = "bookingCard";
        c.innerHTML = `
          <div class="bookingCardTop">
            <div>
              <div class="title">${escapeHtml(b.client)} <span class="muted" style="font-weight:700">â€¢ ${escapeHtml(b.bookingId)}</span></div>
              <div class="sub">${escapeHtml(b.unit)} ${b.contact ? ("â€¢ " + escapeHtml(b.contact)) : ""}</div>
            </div>
            <span class="tag ${statusTagClass(b.status)}">${escapeHtml(b.status)}</span>
          </div>

          <div class="kv">
            <div><span class="muted">Start</span><br><b>${formatDT(b.startISO)}</b></div>
            <div><span class="muted">End</span><br><b>${formatDT(b.endISO)}</b></div>
            <div><span class="muted">Payment</span><br><b>${escapeHtml(b.payment || "â€”")}</b></div>
            <div><span class="muted">Price</span><br><b>${b.price ? ("â‚±" + Number(b.price).toLocaleString()) : "â€”"}</b></div>
          </div>

          <div class="barWrap" style="min-width:unset;">
            <div class="barTop">
              <span class="nowrap">${escapeHtml(p.range)}</span>
              <span class="nowrap">${Math.round(p.pct)}%</span>
            </div>
            <div class="barTrack" title="${escapeHtml(p.nowLabel)}">
              <div class="barFill" style="width:${p.pct}%;"></div>
            </div>
            <div class="barMarkers"><span>Start</span><span>Now</span><span>End</span></div>
            <div class="barNote">${escapeHtml(p.nowLabel)} â€¢ ${escapeHtml(p.note)}</div>
          </div>

          <div class="inlineRow">
            <button type="button" class="ghost" onclick="editBooking('${b.id}')">Edit</button>
            <button type="button" class="danger" onclick="deleteBooking('${b.id}')">Delete</button>
          </div>
        `;
        cards.appendChild(c);
      }
    }

    function renderClock(){
      const now = new Date();
      $("nowClock").textContent = "Now: " + formatDT(now.toISOString());
    }

    function renderAll(){
      renderClock();
      renderBookings();
      updateEndsInline();
    }

    // ---- edit/delete
    window.editBooking = function(id){
      const b = state.bookings.find(x => x.id === id);
      if(!b) return;

      state.editingId = id;
      $("formTitle").textContent = "Edit Booking";
      $("saveBtn").textContent = "Update";

      client.value = b.client || "";
      contact.value = b.contact || "";
      unit.value = b.unit || "";

      const s = new Date(b.startISO);
      if(!isNaN(s)){
        startDate.value = s.toISOString().slice(0,10);
        startTime.value = pad2(s.getHours()) + ":" + pad2(s.getMinutes());
      }
      hours.value = b.hours ?? "";

      status.value = b.status || "Reserved";
      payment.value = b.payment || "Unpaid";
      price.value = b.price ?? "";
      bookingId.value = b.bookingId || "";
      notes.value = b.notes || "";

      updateEndsInline();
      saveDraft();

      // go to dashboard to edit (simple)
      location.hash = "#/dashboard";
      showToast("Editing âœï¸");
    }

    window.deleteBooking = function(id){
      const b = state.bookings.find(x => x.id === id);
      if(!b) return;
      if(!confirm(`Delete booking ${b.bookingId}?`)) return;

      state.bookings = state.bookings.filter(x => x.id !== id);
      persist();
      renderAll();
      if(state.editingId === id) resetForm();
    }

    function clearAll(){
      if(!confirm("This will delete ALL saved bookings on this device/browser. Continue?")) return;
      state.bookings = [];
      persist();
      renderAll();
      resetForm();
    }

    // ---- CSV export/import
    function toCSV(rows){
      const headers = ["bookingId","client","contact","unit","startISO","endISO","hours","status","payment","price","notes","updatedAtISO"];
      const esc = (v) => {
        const s = String(v ?? "");
        if(/[,"\n]/.test(s)) return `"${s.replaceAll('"','""')}"`;
        return s;
      };
      const lines = [headers.join(",")];
      for(const r of rows){
        lines.push(headers.map(h => esc(r[h])).join(","));
      }
      return lines.join("\n");
    }
    function download(filename, text){
      const blob = new Blob([text], { type: "text/csv;charset=utf-8" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(() => URL.revokeObjectURL(a.href), 500);
    }
    function parseCSV(text){
      const rows = [];
      let i=0, field="", row=[], inQuotes=false;

      function pushField(){ row.push(field); field=""; }
      function pushRow(){ rows.push(row); row=[]; }

      while(i < text.length){
        const c = text[i];
        if(inQuotes){
          if(c === '"'){
            if(text[i+1] === '"'){ field += '"'; i += 2; continue; }
            inQuotes = false; i++; continue;
          }
          field += c; i++; continue;
        } else {
          if(c === '"'){ inQuotes = true; i++; continue; }
          if(c === ","){ pushField(); i++; continue; }
          if(c === "\n"){ pushField(); pushRow(); i++; continue; }
          if(c === "\r"){ i++; continue; }
          field += c; i++; continue;
        }
      }
      pushField();
      if(row.length) pushRow();

      const headers = rows.shift();
      if(!headers) return [];

      return rows
        .filter(r => r.some(v => String(v).trim() !== ""))
        .map(r => {
          const obj = {};
          headers.forEach((h, idx) => obj[h] = r[idx] ?? "");
          obj.hours = obj.hours ? Number(obj.hours) : null;
          obj.price = obj.price ? Number(obj.price) : null;
          obj.id = crypto.randomUUID?.() || (Date.now()+"_"+Math.random());
          return obj;
        });
    }
    function exportCSV(){
      const csv = toCSV(state.bookings);
      const d = new Date();
      const fname = `digicam-bookings-${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}.csv`;
      download(fname, csv);
      showToast("Exported CSV âœ…");
    }
    async function importCSVFile(file){
      const text = await file.text();
      const imported = parseCSV(text);

      if(imported.length === 0){
        alert("No rows found in CSV.");
        return;
      }

      const map = new Map(state.bookings.map(b => [b.bookingId, b]));
      for(const r of imported){
        const bid = (r.bookingId || "").trim();
        if(!bid) continue;
        const existing = map.get(bid);
        if(existing){
          map.set(bid, { ...existing, ...r, id: existing.id });
        } else {
          map.set(bid, { ...r, id: crypto.randomUUID?.() || (Date.now()+"_"+Math.random()) });
        }
      }

      state.bookings = Array.from(map.values());
      persist();
      renderAll();
      showToast("Imported âœ…");
    }

    // ---- router
    function setActiveTab(tab){
      $("tabDashboard").classList.toggle("active", tab === "dashboard");
      $("tabBookings").classList.toggle("active", tab === "bookings");
      $("pageDashboard").classList.toggle("active", tab === "dashboard");
      $("pageBookings").classList.toggle("active", tab === "bookings");
    }

    function route(){
      const hash = location.hash || "#/dashboard";
      const tab = hash.includes("bookings") ? "bookings" : "dashboard";
      setActiveTab(tab);
      renderAll();
    }

    // ---- events
    $("saveBtn").addEventListener("click", upsertBooking);
    $("resetBtn").addEventListener("click", () => { resetForm(); showToast("New booking âœ…"); });
    $("clearAllBtn").addEventListener("click", clearAll);

    ["input","change"].forEach(evt => {
      $("search").addEventListener(evt, renderBookings);
      $("filterStatus").addEventListener(evt, renderBookings);
      $("sortBy").addEventListener(evt, renderBookings);
    });

    ["input","change"].forEach(evt => {
      startDate.addEventListener(evt, () => { updateEndsInline(); saveDraft(); });
      startTime.addEventListener(evt, () => { updateEndsInline(); saveDraft(); });
      hours.addEventListener(evt, () => { updateEndsInline(); saveDraft(); });
      client.addEventListener(evt, saveDraft);
      contact.addEventListener(evt, saveDraft);
      unit.addEventListener(evt, saveDraft);
      status.addEventListener(evt, saveDraft);
      payment.addEventListener(evt, saveDraft);
      price.addEventListener(evt, saveDraft);
      bookingId.addEventListener(evt, saveDraft);
      notes.addEventListener(evt, saveDraft);
    });

    $("exportBtn").addEventListener("click", exportCSV);
    $("importBtn").addEventListener("click", () => $("importFile").click());
    $("importFile").addEventListener("change", async (e) => {
      const file = e.target.files && e.target.files[0];
      if(!file) return;
      await importCSVFile(file);
      e.target.value = "";
    });

    window.addEventListener("hashchange", route);

    // keep monitor bars accurate
    setInterval(() => {
      if(state.bookings.length) renderBookings();
      renderClock();
    }, 60 * 1000);

    // ---- init
    load();
    setNowDefaults();
    updateEndsInline();
    loadDraft();
    route();
  </script>
</body>
</html>
